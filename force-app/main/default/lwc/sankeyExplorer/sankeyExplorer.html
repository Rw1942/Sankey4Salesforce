<template>
    <lightning-card title="Sankey Explorer" icon-name="utility:strategy">
        <div slot="actions">
            <lightning-button
                label="Reset"
                icon-name="utility:refresh"
                onclick={handleResetAll}
                variant="neutral">
            </lightning-button>
        </div>

        <div class="slds-p-horizontal_medium slds-p-bottom_small controls-bar">
            <div class="slds-grid slds-gutters_x-small slds-wrap">
                <div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-6">
                    <lightning-combobox
                        name="mode"
                        label="Mode"
                        value={mode}
                        options={modeOptions}
                        onchange={handleModeChange}>
                    </lightning-combobox>
                </div>
                <div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-6">
                    <lightning-combobox
                        name="metric"
                        label="Metric"
                        value={metric}
                        options={metricOptions}
                        onchange={handleMetricChange}>
                    </lightning-combobox>
                </div>

                <template if:true={isRecordTrace}>
                    <div class="slds-col slds-size_1-of-1 slds-medium-size_2-of-6">
                        <lightning-combobox
                            name="record"
                            label="Record"
                            placeholder="Choose a record…"
                            value={selectedRecordId}
                            options={recordOptions}
                            onchange={handleRecordChange}>
                        </lightning-combobox>
                    </div>
                </template>

                <template if:true={isFlowTrace}>
                    <div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-6">
                        <lightning-combobox
                            name="flowStep"
                            label="Step"
                            placeholder="Pick step…"
                            value={flowStepIdx}
                            options={flowStepOptions}
                            onchange={handleFlowStepChange}>
                        </lightning-combobox>
                    </div>
                    <div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-6">
                        <lightning-combobox
                            name="flowValue"
                            label="Value"
                            placeholder="Pick value…"
                            value={flowTraceValue}
                            options={flowValueOptions}
                            onchange={handleFlowValueChange}>
                        </lightning-combobox>
                    </div>
                </template>
            </div>

            <template if:true={showTraceControls}>
                <div class="trace-row slds-m-top_x-small">
                    <lightning-button-group>
                        <lightning-button label="Reset" onclick={handleTraceReset}></lightning-button>
                        <lightning-button label="Prev" onclick={handleTracePrev}></lightning-button>
                        <lightning-button label="Next" variant="brand" onclick={handleTraceNext}></lightning-button>
                    </lightning-button-group>
                    <span class="trace-label slds-m-left_small">{traceStepLabel}</span>
                </div>
            </template>
        </div>

        <div class="chart-container">
            <svg class="sankey" lwc:dom="manual"></svg>
            <div class={tooltipClass} style={tooltipStyle}>
                <div class="tooltip-title">{tooltipTitle}</div>
                <div class="tooltip-detail">{tooltipDetail}</div>
                <template if:true={tooltipExtra}>
                    <div class="tooltip-extra">{tooltipExtra}</div>
                </template>
            </div>
        </div>

        <template if:true={isLoading}>
            <div class="slds-align_absolute-center slds-p-around_large">
                <lightning-spinner alternative-text="Loading" size="medium"></lightning-spinner>
            </div>
        </template>

        <template if:true={errorMessage}>
            <div class="slds-notify slds-notify_alert slds-alert_error slds-m-around_medium" role="alert">
                <span class="slds-assistive-text">error</span>
                {errorMessage}
            </div>
        </template>
    </lightning-card>
</template>
